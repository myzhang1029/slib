#!/bin/sh
#
#  Guess values for system-dependent variables and create Makefiles.
#
#  Copyright (C) 2017, 2018 Zhang Maiyun
#
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
#  This file is part of the slib.
#  The slib  is free software; you can redistribute it and/or modify
#  it under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Default/init vaule of variables
srcdir=`dirname $0`
cross=""
prefix="/usr/local"
libdir=""
includedir=""
mandir=""
infodir=""
cc="${CC}"
ar="${AR}"
rm="rm"
build=""
cflags="${CFLAGS} ${CPPFLAGS} -Wno-variadic-macros -W -Wall -pedantic -c -O3 -I${srcdir}/include"
soflags=""
cfiles="`cd ${srcdir};find src -type f -name '*.c' -printf \"%p \"`"
hfiles="`find ${srcdir}/include -printf \"%p \" -type f -name '*.h' -printf \"%p \"`"
exesuf=""
# Get constants defined in CMakeLists.txt
name="libsbl"
version="`grep project ${srcdir}/CMakeLists.txt|cut -d\  -f3`"
description="`grep DESCRIPTION ${srcdir}/CMakeLists.txt|cut -d\\" -f2`"

. $srcdir/cmake/acconf.sh

check_progs printf cut sed

# Help
help_me(){
	printf 'Usage: %s/configure [option=<vaule> | --help]\n' ${srcdir}
	printf 'Options:\n'
	printf '  --prefix=PREFIX\tSet prefix;\n'
	printf '  --build=BUILD\tconfigure for building on BUILD [guessed]'
	printf '  --host=HOST\tcross-compile to build programs to run on HOST [BUILD]'
	printf '  --target=TARGET\tIgnored'
    printf '  --rm=RM\tSet remover(Should support "-f" option);\n'
	printf '  --exesuf=SUFFIX\tSet suffix of shared objects;\n'
	printf '  --soflags=SOFLAGS\tSet CFLAGS for shared objects\n'
	printf '  --{bin,lib,include,man,info}dir=DIR\t Set bindir, libdir, includedir, mandir, infodir;\n'
	printf '  --help,-h\tDisplay this help information.\n\n'
    printf 'Some influential environment variables:'
    printf '  AR\tlibmaker'
    printf '  CC\tC compiler'
    printf '  CFLAGS\tC flags'
	printf '\nProject maintained by Zhang Maiyun <myzhang1029@163.com>.\n'
	exit 0
}

# Parse arguments
for opt do
    eval opt=\"${opt}\"
    case "${opt}" in
        --prefix=*) prefix=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --host=*) cross=`echo ${opt} | cut -d '=' -f 2`
            if ! [ "$cross" = "" ];
            then
                cross=`${srcdir}/cmake/config.sub $cross` || exit 
            fi
            ;;
        --build=*|--target=*)
            ;;
        --rm=*) rm=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --exesuffix=*) exesuf=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --bindir=*) bindir=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --libdir=*) libdir=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --includedir=*) includedir=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --mandir=*) mandir=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --infodir=*) infodir=`echo ${opt} | cut -d '=' -f 2`
            ;;
        --soflags=*) soflags="${soflags} `echo ${opt} | cut -d '=' -f 2`"
            ;;
        --help|-h) help_me
            ;;
        *) echo configure: Warning: unrecognized option ${opt}
            ;;
    esac
done

# system name for the host platform
if [ "$cross" = "" ];
then
    system_name=`$srcdir/cmake/config.guess`
else
    system_name=$cross
fi
echo Starting configuration for host $system_name
system_name=`extract_os $system_name`

# Check for C compiler
if [ "$cc" = "" ];
then
    check_cc $cross
fi

# Check for ar
if [ "$ar" = "" ] ; then
    check_ar $cross
fi

# For exesuf
printf "Checking suffix for shared objects... "

case $system_name in
    *linux*|*bsd*|sunos*|minix*|solaris*) exesuf=".so"
        soflags="-fPIC -shared -Os"
        ;;
    darwin*|*step*) exesuf=".dylib"
        soflags="-dynamiclib -current_version $version"
        ;;
    windows*|mingw*|msys*|cygwin*) exesuf=".dll";soflags="-shared"
        ;;
    *) echo unknown
        echo configure: Error: unable to determine suffix for shared objects"(aka dylib/so/dll)", please add option --exesuffix
        exit 1
esac
echo $exesuf

if check_header "alloca.h";
then
    alloca_h=1
else
    alloca_h=0
fi

if check_header "fcntl.h";
then
    fcntl_h=1
else
    fcntl_h=0
fi

if check_header "termios.h";
then
    termios_h=1
else
    termios_h=0
fi

if check_header "unistd.h";
then
    unistd_h=1
else
    unistd_h=0
fi

if [ "$libdir" = "" ] ; then
	libdir="$prefix/lib"
fi
if [ "$includedir" = "" ] ; then
	includedir="$prefix/include"
fi

# Write output
echo Generating Makefile
cat > Makefile << ACEOF
# Makefile generated by configure
OBJECTS=`echo ${cfiles} | sed s/\\\.c/.c.o/g`

# Always write an all target
all:libsbl${exesuf}

libsbl${exesuf}: src ${hfiles} \$(OBJECTS)
	${cc} ${soflags} \$(OBJECTS) -o \$@
	${ar} rcs ./libsbl.a \$(OBJECTS)
    
src:
	mkdir src

install:all
	install -c -d -m 755 ${libdir} ${includedir} ${includedir}/slib
	install -c -p -m 644 include/slib.h ${includedir}
	install -c -p -m 644 include/slib ${includedir}
	install -c -p -m 644 sbl.pc ${libdir}/pkgconfig
	install -c -p -m 644 libsbl.a ${libdir}
	install -c -p -m 755 libsbl${exesuf} ${libdir}

.PHONY: clean
clean:
	${rm} -f libsbl.dylib libsbl.dll libsbl.so *.o */*.o *.a
	-rmdir src 2>/dev/null

distclean: clean
	${rm} -f Makefile config.mk config.h sbl.pc

# Everything below is the same, you will not like to read it line by line
ACEOF
for file in $cfiles;
do
	echo ${file}.o:${srcdir}/${file} >> Makefile
    echo "	${cc} ${cflags} -c -o \$@ \$^" >> Makefile
done

echo Generating sbl.pc
sed "s,@CMAKE_INSTALL_PREFIX@,${prefix},;s,@CMAKE_INSTALL_LIBDIR@,lib,;\
    s,@CMAKE_INSTALL_INCLUDEDIR@,include,;s,@PROJECT_NAME@,${name},;\
    s,@PROJECT_DESCRIPTION@,${description},;\
    s,@PROJECT_VERSION@,${version},;" ${srcdir}/sbl.pc.in > sbl.pc

echo Generating config.h
